---
- name: test provision for iRODS
  hosts: irods:!unmanaged_systems
  become: true
  vars:
    #     Python 2 in Ansible 2.9.6
    # NB: The rpm and yum bindings for the test_pkg_installed.yml tasks require
    ansible_python_interpreter: /usr/bin/python
    group_name: >-
      {{ 'irods_provider' if inventory_hostname in groups['irods_catalog'] else 'irods' }}
  tasks:
    - include_tasks: tasks/test_pkg_installed.yml
      with_items:
        - uuidd
        - which
      loop_control:
        loop_var: pkg

      # XXX: After DS-47 is deployed, this should be removed
    - when: ansible_distribution == 'CentOS'
      block:
        - include_tasks: tasks/test_pkg_installed.yml
          vars:
            pkg: yum-plugin-versionlock

        - name: test lock NetCDF plugins to version 4.2.8.0
          shell: |
            set -o pipefail
            if ! yum versionlock status | grep --quiet '{{ item  }}'; then
              printf '{{ item  }} not locked\n' >&2
              exit 1
            elif info="$(yum --quiet list installed '{{ item  }}' | tail --lines=+2)"; then
              readarray -t versions <<< "$info"
              for version in "${versions[@]}"; do
                read _ verNum _ <<< "$version"
                if ! [[ "$verNum" =~ 4\.2\.8.\0 ]]; then
                  printf 'found version %s\n' "$verNum" >&2
                  exit 1
                fi
              done
            fi
          changed_when: false
          with_items:
            - irods-netcdf-client_modules
            - irods-netcdf-icommands
            - irods-netcdf-server_modules

    - name: test create service group
      command:
        cmd: sed --quiet 's/^{{ group_name }}:x:\([0-9]\+\):.*/\1/p' /etc/group
        warn: false
      register: gid_resp
      changed_when: false
      failed_when: gid_resp.stdout|length == 0

    - name: verify that the system user has correct comment
      command:
        cmd: >
          grep --quiet --regexp '^irods:x:[0-9]*:{{ gid_resp.stdout }}:iRODS Administrator:'
          /etc/passwd
      changed_when: false

    - name: verify that system user belongs to tty group
      command:
        cmd: grep --quiet --regexp '^tty:x:[0-9]*:\(.\+,\)\?irods\(,.\+\)\?$' /etc/group
      changed_when: false
