---
- name: test install HAProxy
  hosts: proxy
  become: true
  tasks:
    - name: test change rsyslog.conf block Id to proxy
      command: "grep --invert --quiet 'DS MANAGED BLOCK (load_balancer)' /etc/rsyslog.conf"
      changed_when: false

    - name: test configure rsyslog to listen on UDP socket
      shell: |
        printf -v expSettings '$ModLoad imudp\n$UDPServerRun 514\n$UDPServerAddress 127.0.0.1'

        actSettings=$(sed --quiet \
          '/^# BEGIN DS MANAGED BLOCK (proxy)/{N;N;N;s/^[^\n]*\n//;p}' /etc/rsyslog.conf)

        [[ "$actSettings" = "$expSettings" ]]
      changed_when: false

    - name: test place rsyslog config for HAProxy
      stat:
        path: /etc/rsyslog.d/haproxy.conf
      register: result
      failed_when: not result.stat.exists

    - name: test place logrotate config for HAProxy
      stat:
        path: /etc/logrotate.d/haproxy
      register: result
      failed_when: not result.stat.exists

    - name: test change iptables load_balancer block Ids to proxy
      debug:
        msg: TODO implement

    - name: test disable conntrack for proxied connections
      debug:
        msg: TODO implement

    - name: test open firewall for relevant connections
      debug:
        msg: TODO implement
