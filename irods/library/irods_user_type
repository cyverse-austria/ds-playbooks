#!/bin/bash
#
# An ansible module for managing iRODS user types. At the moment, it can only
# create them.
#
# Module Name:
#  irods_user_type
#
# Required Variables:
#  type  the type of user to create
#
# Optional Variables:
#  description  the description of the user type

# WANT_JSON

main()
{
  local varFile="$1"
  local type
  local description

  type=$(read_field "$varFile" type)
  description=$(read_field "$varFile" description '')

  local id
  id=$(quest "select TOKEN_ID where TOKEN_NAMESPACE = 'user_type' and TOKEN_NAME = '$type'")

  if [ -z "$id" ]; then
    local errMsg
    if ! errMsg=$(iadmin at user_type "$type" "" "$description"); then
      fail "$errMsg"
    fi
    changed="true"
  else
    local currentDesc
    currentDesc=$(quest "select TOKEN_VALUE2 where TOKEN_ID = '$id'")
    if [ "$description" != "$currentDesc" ]; then
      fail "user type $type already in use for another purpose"
    fi
  fi
  endoutput
}

quest()
{
  local query="$*"

  local response
  # if ! response=$(iquest --no-page '%s' "$query" 2>&1)
  if ! response=$(iquest --no-page '%s' "$query"); then
    fail "$response"
  fi

  if ! [[ "$response" =~ ^CAT_NO_ROWS_FOUND ]]; then
    printf '%s' "$response"
  fi
}

read_field()
{
  local varFile="$1"
  local field="$2"

  local defaultValue
  if [ "$#" -ge 3 ]; then
    defaultValue="$3"
  fi

  local value
  if ! value=$(jq --raw-output ".$field // empty" < "$varFile"); then
    fail "$value"
  elif [ -z "$value" ]; then
    if [ "${defaultValue:-}" ]; then
      value="$defaultValue"
    else
      fail "variable '$field' must be defined"
    fi
  fi

  printf '%s' "$value"
}

fail()
{
  rc="1"
  msg="$*"
}

endoutput()
{
  stderr="$(cat ${stderroutfile})"
  jq -M -n \
    --arg changed "$changed" \
    --arg rc "$rc" \
    --arg stdout "$stdout" \
    --arg stderr "$stderr" \
    --arg msg "$msg" \
    '$ARGS.named'
  exit ${rc}
}

set -e
changed="false"
rc=0
stdout=""
stderr=""
msg=""
stderroutfile="/tmp/stderr"
trap 'rm -f ${tmpfstderr}' 0 1 2 3
main "$@" 2> ${stderroutfile}
