---
- name: test irods_unixfilesystem_resource module
  hosts: localhost
  vars:
    rs: "{{ groups['irods_resource'][0] }}"
    default_resc_vault: /irods/test_vault
    default_resc_name: defaultRes
    options_resc_name: optionsRes
    options_resc_vault: /irods/test_vault2
    options_resc_context: context_message_here
    options_resc_status: up
    options_resc_free_space: 2000000
  pre_tasks:
    - name: create test irods environment
      shell: |
        set -o errexit
        if ! [[ -e "$HOME"/.irods/.irodsA ]]; then
          iinit "$IRODS_PASSWORD"
          echo changed
        fi
      register: response
      changed_when: response.stdout == 'changed'

  tasks:
    - name: run script without optional vars
      irods_unixfilesystem_resource:
        name: "{{ default_resc_name }}"
        location: "{{ rs }}"
        vault: "{{ default_resc_vault }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response

    - name: run script with optional vars
      irods_unixfilesystem_resource:
        name: "{{ options_resc_name }}"
        location: "{{ rs }}"
        vault: "{{ options_resc_vault }}"
        context: "{{ options_resc_context }}"
        status: "{{ options_resc_status }}"
        free_space: " {{ options_resc_free_space }} "
        port: 1247
        host: "{{ groups['irods_catalog'][0] }}"
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response

    - name: check resource names
      shell: |
        set -o errexit
        test \
          "$(iquest %s "SELECT RESC_NAME WHERE RESC_NAME = '{{ default_resc_name }}'")" \
          = '{{ default_resc_name }}'
        test \
          "$(iquest %s "SELECT RESC_NAME WHERE RESC_NAME = '{{ options_resc_name }}'")" \
          = '{{ options_resc_name }}'
      changed_when: false

    - name: check resource path
      shell: |
        set -o errexit
        test \
          "$(iquest %s "SELECT RESC_VAULT_PATH WHERE RESC_NAME = '{{ default_resc_name }}'")" \
          = '{{ default_resc_vault }}'
        test \
          "$(iquest %s "SELECT RESC_VAULT_PATH WHERE RESC_NAME = '{{ options_resc_name }}'")" \
          = '{{ options_resc_vault }}'
      changed_when: false

    - name: check resource host
      shell: |
        set -o errexit
        test \
          "$(iquest %s "SELECT RESC_LOC WHERE RESC_NAME = '{{ default_resc_name }}'")" = '{{ rs }}'
        test \
          "$(iquest %s "SELECT RESC_LOC WHERE RESC_NAME = '{{ options_resc_name }}'")" = '{{ rs }}'
      changed_when: false

    - name: check resource context
      shell: |
        test \
          "$(iquest %s "SELECT RESC_CONTEXT WHERE RESC_NAME = '{{ options_resc_name }}'")" \
          = '{{ options_resc_context }}'
      changed_when: false

    - name: check resource status
      shell: |
        test \
          "$(iquest %s "SELECT RESC_STATUS WHERE RESC_NAME = '{{ options_resc_name }}'")" \
          = '{{ options_resc_status }}'
      changed_when: false

    - name: check init_free_space
      shell: |
        test \
          "$(iquest %s "SELECT RESC_FREE_SPACE WHERE RESC_NAME = '{{ options_resc_name }}'")" \
          = '{{ options_resc_free_space }}'
      changed_when: false
