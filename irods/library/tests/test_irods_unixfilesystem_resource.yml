---
- name: test irods_unixfilesystem_resource module
  hosts: localhost
  gather_facts: false
  vars:
    TEST_RSC_NAME: test_unix_rsc
    TEST_RSC_NAME2: test_unix_rsc2
    TEST_HOST_NAME: "{{ groups['irods_catalog'][0] }}"
    TEST_VAULT_PATH: /irods/test_vault
    TEST_VAULT_PATH2: /irods/test_vault2
    TEST_CONTEXT: context_message_here
    TEST_STATUS: up
    TEST_FREE_SPACE: 2000000
  environment:
    TEST_PORT: 1247
    TEST_USER_NAME: rods
    TEST_HOST: "{{ groups['irods_catalog'][0] }}"
    TEST_PASSWORD: rods
    TEST_ZONE_NAME: testing
  pre_tasks:
    - name: create test irods environment
      shell: |
        set -o errexit
        iinit "$IRODS_PASSWORD"

  tasks:
    - name: run script without optional vars
      irods_unixfilesystem_resource:
        name: "{{ TEST_RSC_NAME }}"
        host: "{{ TEST_HOST_NAME }}"
        vault_path: "{{ TEST_VAULT_PATH }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response

    - name: run script with optional vars
      irods_unixfilesystem_resource:
        name: "{{ TEST_RSC_NAME2 }}"
        host: "{{ TEST_HOST_NAME }}"
        vault_path: "{{ TEST_VAULT_PATH2 }}"
        context: "{{ TEST_CONTEXT }}"
        status: "{{ TEST_STATUS }}"
        free_space: " {{ TEST_FREE_SPACE }} "
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response

    - name: check resource name
      shell: |
        set -o errexit
        test "$(iquest "SELECT RESC_NAME WHERE RESC_NAME = '{{ TEST_RSC_NAME }}'")" != '{{ TEST_RSC_NAME }}'
        test "$(iquest "SELECT RESC_NAME WHERE RESC_NAME = '{{ TEST_RSC_NAME2 }}'")" != '{{ TEST_RSC_NAME2 }}'
      register: response

    - name: check resource path
      shell: |
        test "$(iquest "SELECT RESC_VAULT_PATH WHERE RESC_NAME = '{{ TEST_RSC_NAME }}'")" != '{{ TEST_VAULT_PATH }}'
        test "$(iquest "SELECT RESC_VAULT_PATH WHERE RESC_NAME = '{{ TEST_RSC_NAME2 }}'")" != '{{ TEST_VAULT_PATH2 }}'
      register: response

    - name: check resource host
      shell: |
        test "$(iquest "SELECT SL_HOST_NAME WHERE RESC_NAME = '{{ TEST_RSC_NAME }}'")" != '{{ TEST_HOST_NAME }}'
        test "$(iquest "SELECT SL_HOST_NAME WHERE RESC_NAME = '{{ TEST_RSC_NAME2 }}'")" != '{{ TEST_HOST_NAME }}'
      register: response

    - name: check resource context
      shell: |
        test "$(iquest "SELECT RESC_CONTEXT WHERE RESC_NAME = '{{ TEST_RSC_NAME2 }}'")" != '{{ TEST_CONTEXT }}'
      register: response

    - name: check resource status
      shell: |
        test "$(iquest "SELECT RESC_STATUS WHERE RESC_NAME = '{{ TEST_RSC_NAME2 }}'")" != '{{ TEST_STATUS }}'
      register: response

    - name: check init_free_space
      shell: |
        test "$(iquest "SELECT RESC_FREE_SPACE WHERE RESC_NAME = '{{ TEST_RSC_NAME2 }}'")" != '{{ TEST_FREE_SPACE }}'
      register: response
