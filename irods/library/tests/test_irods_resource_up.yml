---
- name: Test play for irods_resource_up module
  hosts: localhost
  vars: 
    TEST_RSC: replRes
    MISSINGNO: missingRes
  environment:
    TEST_PORT: 1247
    TEST_USER_NAME: rods
    TEST_HOST: "{{ groups['irods_catalog'][0] }}"
    TEST_PASSWORD: rods
    TEST_ZONE_NAME: testing
  pre_tasks:
    - name: Initialize irods session
      shell: |
        iinit <<< ${IRODS_PASSWORD}
      tags:
        - non_idempotent

  tasks:
    - name: bring up resource
      irods_resource_up:
        resource: "{{ TEST_RSC }}"
        host: "{{ groups['irods_catalog'][0] }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing

    - name: verify resource up
      shell: test up = "$(iquest '%s' "select RESC_STATUS where RESC_NAME = '{{ TEST_RSC }}'")"
      changed_when: false
      register: response

    - name: verify resource parents up
      shell: |
        function verify_parent_status () {
          next_rsc="$(iquest '%s' "SELECT RESC_PARENT WHERE RESC_NAME = $1")"
          if [-n next_rsc]
          then
            status="$(iquest "SELECT RESC_STATUS WHERE RESC_NAME = '$next_rsc'")"
            verify_parent_status next_resc
          else
            return 0
          fi
        }
        verify_parent_status '{{ TEST_RSC }}'
      changed_when: false
      register: response

    - name: test with non-existent resource
      failed_when: response is success or response.msg != "Resource 'missingRes' does not exist"
      irods_resource_up:
        resource: "{{ MISSINGNO }}"
        host: "{{ groups['irods_catalog'][0] }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response 